<!-- a3024842-c3ba-4a17-9ee6-bc73bf907393 61982a99-3a72-4fb6-8870-aca17343507f -->
# Blob Pattern Configurator

## Overview

Create a system to define and apply 4x4 tile tessellation patterns for biome blob interiors, eliminating repetitive patterns in mountains and other biomes.

## Changes Required

### 1. Enhance Stitch Designer UI

Modify [terrain_generator_demo.html](terrain_generator_demo.html) to:

- Add biome selector dropdown (rock/mountain, grass, dirt, sand)
- Add "Save Pattern" button that persists to localStorage
- Add "Load Patterns" display showing saved patterns per biome
- Update palette to show tiles relevant to selected biome

Key UI additions around line 710-740:

```html
<select id="blobPatternBiome">
    <option value="rock_mountain">Mountain/Rock</option>
    <option value="grass">Grass</option>
    <option value="dirt">Dirt</option>
</select>
<button onclick="saveBlobPattern()">Save Pattern</button>
```

### 2. Add localStorage Persistence

Add functions in [terrain_generator_demo.html](terrain_generator_demo.html) around line 3450:

```javascript
// Save pattern to localStorage under "blobPatterns"
window.saveBlobPattern = function() {
    const biome = document.getElementById('blobPatternBiome').value;
    const patterns = JSON.parse(localStorage.getItem('blobPatterns') || '{}');
    patterns[biome] = stitchGridState; // 16-element array for 4x4
    localStorage.setItem('blobPatterns', JSON.stringify(patterns));
};

// Load saved patterns
window.loadBlobPatterns = function() {
    return JSON.parse(localStorage.getItem('blobPatterns') || '{}');
};
```

### 3. Modify Tile Selection in Terrain Generator

Update [js/data/uoTileSetsClean.js](js/data/uoTileSetsClean.js):

Replace the simple hash in `getMountainRockTile()` (line 455) with pattern-aware selection:

```javascript
export function getMountainRockTile(x, y) {
    // Check for saved blob pattern
    const patterns = JSON.parse(localStorage.getItem('blobPatterns') || '{}');
    const pattern = patterns['rock_mountain'];
    
    if (pattern && pattern.length === 16) {
        // Use 4x4 pattern tiled across the blob
        const patternX = x % 4;
        const patternY = y % 4;
        const tileId = pattern[patternY * 4 + patternX];
        if (tileId) return parseInt(tileId.replace('0x', ''), 16);
    }
    
    // Fallback to original behavior
    // ...existing code...
}
```

### 4. Add Generic Blob Pattern Function

Add new function in [js/data/uoTileSetsClean.js](js/data/uoTileSetsClean.js):

```javascript
export function getBlobPatternTile(biome, x, y) {
    const patterns = JSON.parse(localStorage.getItem('blobPatterns') || '{}');
    const pattern = patterns[biome];
    
    if (pattern && pattern.length === 16) {
        const patternX = x % 4;
        const patternY = y % 4;
        const tileId = pattern[patternY * 4 + patternX];
        if (tileId) return parseInt(tileId.replace('0x', ''), 16);
    }
    return null; // No pattern, use default
}
```

### 5. Integrate in Terrain Generation

Update `getContextualTile()` in [js/data/uoTileSetsClean.js](js/data/uoTileSetsClean.js) (around line 480) to check for blob patterns before default selection:

```javascript
export function getContextualTile(biome, x, y, context = {}) {
    // Check for user-defined blob pattern first
    const patternTile = getBlobPatternTile(biome, x, y);
    if (patternTile) return patternTile;
    
    // ...existing contextual logic...
}
```

## Files to Modify

1. [terrain_generator_demo.html](terrain_generator_demo.html) - UI enhancements and save/load functions
2. [js/data/uoTileSetsClean.js](js/data/uoTileSetsClean.js) - Pattern-aware tile selection

## Testing

1. Open Stitch Designer, select Mountain biome
2. Paint a 4x4 pattern using the mountain tiles
3. Click "Save Pattern"
4. Generate terrain with "Procedural Enhanced"
5. Verify mountain blobs use the defined 4x4 pattern tiled across

### To-dos

- [ ] Design stamp-based placement algorithm for 3x3 patterns
- [ ] Find edge locations and determine edge direction
- [ ] Place complete 3x3 stamps as units along edges
- [ ] Test stamp placement with labels enabled
- [ ] Add colored stamp outlines in renderPatternLabels() function
- [ ] Add debug logging to identify why rock-grass tiles are being skipped
- [ ] Fix edge detection to include all rock-grass boundary tiles
- [ ] Implement stamp-based 3x3 pattern placement
- [ ] Store pattern.directionId on tiles in placeStamp() function
- [ ] Update label rendering to show stampConfigName (at CENTER tile)
- [ ] Add biome selector dropdown to Stitch Designer UI
- [ ] Add saveBlobPattern() and loadBlobPatterns() localStorage functions
- [ ] Add getBlobPatternTile() function in uoTileSetsClean.js
- [ ] Update getMountainRockTile() to use saved patterns
- [ ] Update getContextualTile() to check blob patterns first
- [ ] Test saving pattern and generating terrain with it